

<!DOCTYPE html>
<html>
<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="shortcut icon" href="favicon.ico">
    <link href="/static/hp/css/bootstrap.min.css?v=3.3.6" rel="stylesheet">
    <link href="/static/hp/css/font-awesome.css?v=4.4.0" rel="stylesheet">
    <link href="/static/hp/css/animate.css" rel="stylesheet">
    <link href="/static/hp/css/style.css?v=4.1.0" rel="stylesheet">

</head>

<body class="gray-bg">
    <div class="wrapper wrapper-content animated fadeInRight">
        <div class="row">
            <div class="col-sm-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>核查信息</h5>
                    </div>
                    <div class="ibox-content">
                        <form method="post" class="form-horizontal" action="/admin/company_check_edit">
                            <input type="hidden" name="id" value="{{item.id}}">
                            <input type="hidden" name="oper" value="{{'edit' if item and item.id else 'add'}}">
                            <div class="form-group">
                                <label class="col-sm-2 control-label">系统名称</label>
                                <div class="col-sm-10">
                                    {{item.from}}
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="col-sm-2 control-label">认证信息</label>
                                <div class="col-sm-10">
                                  {{item.auth_info}}
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="col-sm-2 control-label">获取信息</label>
                                <div class="col-sm-10">
                                  {{item.fetch_info}}
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="col-sm-2 control-label">格式化信息</label>
                                <div class="col-sm-10">
                                  {{item.format_text}}
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="col-sm-2 control-label">核查结果</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" name="result" value="{{item.result}}">
                                </div>
                            </div>

                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <div class="col-sm-4 col-sm-offset-2">
                                  <button class="btn btn-primary" type="submit">{{'保存' if item.id else '添加'}}</button>
                                  <a class="btn btn-white" href="javascript:history.go(-1)">取消</a>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>变更信息</h5>
                        <div class="ibox-tools">
                            <a class="btn btn-primary btn-xs" href="/admin/company_edit?id={{company.id}}" >详情</a>
                        </div>
                    </div>
                    <div class="ibox-content">
                        <table class="table table-bordered" id='tbl-compare'>
                          <thead>
                            <tr>
                              <th></th>
                              <th>字段</th>
                              <th>旧值</th>
                              <th>新值(点击修改)</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr>
                              <td><input type="checkbox"></td>
                              <td>名称</td>
                              <td>{{company.name}}</td>
                              <td>{{item.format_json.base.name}}</td>
                            </tr>
                            <tr>
                              <td><input type="checkbox"></td>
                              <td>统一社会信用代码</td>
                              <td>{{company.uscc}}</td>
                              <td>{{item.format_json.base.uscc}}</td>
                            </tr>
                          </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>评级数据</h5>
                        <div class="ibox-tools">
                            <button id="btn-import" class="btn btn-primary btn-xs" >导入</button>
                        </div>
                    </div>
                    <div class="ibox-content">
                      <table class="table table-bordered">
                        <thead>
                          <tr>
                            <th></th>
                            <th>阶段</th>
                            <th>实缴税收</th>
                            <th>总资产</th>
                            <th>总资本</th>
                            <th>总权益</th>
                            <th>财务费用</th>
                            <th>总负债</th>
                            <th>营业收入</th>
                            <th>市值</th>
                            <th>退税</th>
                            <th>操作</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for o in item.format_json.level %}
                          <tr >
                            <td>
                              <input type="checkbox">
                            </td>
                            <td>{{o.stage}}</td>
                            <td>{{o.d1}}</td>
                            <td>{{o.d2}}</td>
                            <td>{{o.d3}}</td>
                            <td>{{o.d4}}</td>
                            <td>{{o.d5}}</td>
                            <td>{{o.d6}}</td>
                            <td>{{o.d7}}</td>
                            <td>{{o.d8}}</td>
                            <td>{{o.d9}}</td>
                            <td><button class="btn btn-primary btn-xs" data-toggle="collapse" data-target="#level_{{loop.index}}" aria-expanded="true" aria-controls="level_{{loop.index}}">明细</button></td>
                          </tr>
                          {% if o.d1_list %}
                          <tr class="collapse" id="level_{{loop.index}}">
                            <td colspan="12">
                              <h3>实缴税收明细</h3>
                              <table class="table table-bordered">
                                <thead>
                                  <tr>
                                    <th>名称</th>
                                    <th>时间</th>
                                    <th>金额</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  {% for p in o.d1_list %}
                                  <tr>
                                    <td>{{p.name}}</td>
                                    <td>{{p.time}}</td>
                                    <td>{{p.money}}</td>
                                  </tr>
                                  {% endfor %}
                                </tbody>
                              </table>
                            </td>
                          </tr>
                          {% endif %}
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 全局js -->
    <script src="/static/hp/js/jquery.min.js?v=2.1.4"></script>
    <script src="/static/hp/js/bootstrap.min.js?v=3.3.6"></script>

    <!-- 自定义js -->
    <script src="/static/hp/js/content.js?v=1.0.0"></script>

    <!-- jQuery Validation plugin javascript-->
    <script src="/static/hp/js/plugins/validate/jquery.validate.min.js"></script>
    <script src="/static/hp/js/plugins/validate/messages_zh.min.js"></script>

    <script src="/static/js/lodash.min.js"></script>
    <script>

        var checkCompare = function(){
          $('#tbl-compare tbody tr').each(function(){
            var ov = $('td:eq(2)', this).text();
            var nv = $('td:eq(3)', this).text();
            if(ov == nv) $(this).addClass('success');
            else $(this).addClass('warning');
          })
        }
        $(function(){
            $('form').validate({
              messages: {
                username:{
                  required:'请输入用户名'
                },
                password:{
                  required:'请输入密码'
                }
              },
              submitHandler:function(form){
                var $form = $(form);

                var data = _.reduce($form.serializeArray(), function(result, o){
                  var val = result[o.name];
                  val = val ? (val + ',' + o.value) : o.value;
                  result[o.name] = val;
                  return result;
                }, {});

                var url = $form.attr('action');
                var type = $form.attr('method')
                $.ajax({
                  url: url,
                  type: type,
                  data: data,
                  success: function(resp){
                    if(resp.errno == 0){
                      alert('操作成功')
                      if(resp.data.redirect) window.location.href = resp.data.redirect;
                      else history.go(-1);
                    }else{
                      alert(resp.errmsg);
                    }
                  }
                });
              }
            });

            $('#tbl-compare tbody tr td:nth-child(4)').click(function(){
              var nv = prompt('请输入新值',$(this).text());
              if(nv != null){
                $(this).text(nv);
              }
            })

            $('#btn-import').click(function(){
              var url = '/admin/company_level_edit';
              var type = 'post';

              alert('{{item.format_json.level|dump}}');
              // $.ajax({
              //   url: url,
              //   type: type,
              //   data: data,
              //   success: function(resp){
              //     if(resp.errno == 0){
              //       alert('操作成功')
              //       if(resp.data.redirect) window.location.href = resp.data.redirect;
              //       else history.go(-1);
              //     }else{
              //       alert(resp.errmsg);
              //     }
              //   }
              // });
            })
        });
    </script>

</body>

</html>
